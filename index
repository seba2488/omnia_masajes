<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spa Roxi - Gestión de Turnos y Promociones</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #8B5CF6;
            --secondary-color: #EC4899;
            --light-purple: #F3E8FF;
            --dark-purple: #5B21B6;
        }
        
        body {
            background: linear-gradient(135deg, #f5f3ff 0%, #e6e0ff 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
        }
        
        .navbar-brand {
            font-weight: 700;
            color: var(--primary-color) !important;
        }
        
        .hero-section {
            background: linear-gradient(rgba(139, 92, 246, 0.8), rgba(236, 72, 153, 0.8)), url('https://placehold.co/1200x600/8B5CF6/F3E8FF?text=Spa+Roxi') no-repeat center center;
            background-size: cover;
            height: 60vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
        }
        
        .card {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: none;
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .admin-panel {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 15px 50px rgba(139, 92, 246, 0.2);
        }
        
        .login-form {
            max-width: 400px;
            margin: 2rem auto;
        }
        
        .btn-primary {
            background: var(--primary-color);
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
        }
        
        .btn-secondary {
            background: var(--secondary-color);
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
        }
        
        .promotion-item {
            border-left: 4px solid var(--primary-color);
            margin-bottom: 1rem;
            padding-left: 1rem;
        }
        
        .image-placeholder {
            background: var(--light-purple);
            border: 2px dashed #ddd;
            border-radius: 10px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--dark-purple);
            font-weight: 600;
        }
        
        .hidden {
            display: none !important;
        }
        
        .admin-header {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
        }
        
        .appointment-card {
            background: var(--light-purple);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary-color);
        }
        
        .booking-section {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 15px 50px rgba(139, 92, 246, 0.2);
            margin-top: 2rem;
        }
        
        .available-slot {
            background: #e8f5e8;
            border: 2px solid #4CAF50;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .available-slot:hover {
            background: #d4edda;
            transform: scale(1.02);
        }
        
        .booked-slot {
            background: #ffe8e8;
            border: 2px solid #f44336;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            opacity: 0.7;
        }
        
        .success-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            margin: 2rem 0;
        }
        
        .preview-container {
            background: #f8f9fa;
            border: 2px dashed #ced4da;
            border-radius: 10px;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 1rem 0;
            padding: 20px;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 180px;
            object-fit: contain;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-spa me-2"></i>Spa Roxi
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#home">Inicio</a>
                    </li>
                    <li class="nav-item" id="public-promotions-link">
                        <a class="nav-link" href="#promotions">Promociones</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#booking">Reservar Turno</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#gallery">Galería</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#admin">Admin</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section id="home" class="hero-section">
        <div class="container">
            <h1 class="display-4 fw-bold">Bienvenido a Spa Roxi</h1>
            <p class="lead">Experiencias de masaje relajantes y rejuvenecedoras</p>
            <button class="btn btn-light btn-lg mt-3" onclick="document.getElementById('booking').scrollIntoView({behavior: 'smooth'})">
                <i class="fas fa-calendar-plus me-2"></i>Reservar Turno
            </button>
        </div>
    </section>

    <!-- Promotions Section (Public) -->
    <section id="promotions" class="py-5">
        <div class="container">
            <h2 class="text-center mb-5 fw-bold" style="color: var(--dark-purple);">Promociones Actuales</h2>
            <div class="row" id="public-promotions-container">
                <!-- Public promotions will be populated by JavaScript -->
            </div>
        </div>
    </section>

    <!-- Booking Section -->
    <section id="booking" class="py-5">
        <div class="container">
            <div class="booking-section">
                <h2 class="text-center mb-4 fw-bold" style="color: var(--dark-purple);">
                    <i class="fas fa-calendar-check me-2"></i>Reservar Turno
                </h2>
                <p class="text-center text-muted mb-4">Seleccione una fecha y horario disponible</p>
                
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <label class="form-label fw-bold">Seleccione Fecha</label>
                        <input type="date" class="form-control" id="booking-date" min="">
                    </div>
                    <div class="col-md-6 mb-4">
                        <label class="form-label fw-bold">Tipo de Masaje</label>
                        <select class="form-select" id="booking-type">
                            <option value="relajante">Masaje Relajante (60 min)</option>
                            <option value="descontracturante">Masaje Descontracturante (75 min)</option>
                            <option value="deportivo">Masaje Deportivo (90 min)</option>
                            <option value="pareja">Pareja Romántica (120 min)</option>
                        </select>
                    </div>
                </div>
                
                <div id="time-slots" class="mb-4">
                    <h5 class="fw-bold mb-3">Horarios Disponibles</h5>
                    <div id="slots-container">
                        <!-- Slots will be populated by JavaScript -->
                    </div>
                </div>
                
                <div id="booking-form" class="hidden">
                    <h5 class="fw-bold mb-3">Complete sus datos</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nombre Completo *</label>
                            <input type="text" class="form-control" id="client-name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Teléfono *</label>
                            <input type="tel" class="form-control" id="client-phone" required placeholder="+54 9 11 1234-5678">
                        </div>
                    </div>
                    <div class="d-flex justify-content-between">
                        <button class="btn btn-secondary" id="back-to-slots">
                            <i class="fas fa-arrow-left me-1"></i>Volver a Horarios
                        </button>
                        <button class="btn btn-primary" id="confirm-booking">
                            <i class="fas fa-check-circle me-1"></i>Confirmar Reserva
                        </button>
                    </div>
                </div>
                
                <div id="booking-success" class="hidden">
                    <div class="success-message">
                        <h4 class="fw-bold text-success">
                            <i class="fas fa-check-circle me-2"></i>¡Reserva Confirmada!
                        </h4>
                        <p id="booking-confirmation-text"></p>
                        <button class="btn btn-primary mt-3" onclick="resetBookingForm()">
                            <i class="fas fa-plus me-1"></i>Reservar Otro Turno
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Gallery Section -->
    <section id="gallery" class="py-5 bg-light">
        <div class="container">
            <h2 class="text-center mb-5 fw-bold" style="color: var(--dark-purple);">Nuestra Galería</h2>
            <div class="row" id="gallery-container">
                <!-- Gallery will be populated by JavaScript -->
            </div>
        </div>
    </section>

    <!-- Admin Section -->
    <section id="admin" class="py-5">
        <div class="container">
            <div class="admin-panel">
                <div id="login-section">
                    <div class="text-center mb-4">
                        <h3 class="fw-bold">Panel de Administración</h3>
                        <p>Ingrese la contraseña para acceder</p>
                    </div>
                    <form id="login-form" class="login-form">
                        <div class="mb-3">
                            <input type="password" class="form-control" id="password" placeholder="Contraseña" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Ingresar</button>
                    </form>
                </div>

                <div id="admin-dashboard" class="hidden">
                    <div class="admin-header">
                        <h3><i class="fas fa-lock me-2"></i>Panel de Administración - Spa Roxi</h3>
                    </div>

                    <ul class="nav nav-tabs mb-4" id="adminTabs">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#appointments">Gestión de Turnos</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#promotions-admin">Promociones</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#gallery-admin">Galería</a>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <!-- Appointments Tab -->
                        <div class="tab-pane fade show active" id="appointments">
                            <h5><i class="fas fa-calendar-alt me-2"></i>Turnos Programados</h5>
                            <div id="admin-appointments-list">
                                <!-- Appointments will be populated by JavaScript -->
                            </div>
                            <div class="alert alert-info mt-3">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Nota sobre Google Calendar:</strong> Esta versión no incluye integración con Google Calendar. 
                                Para implementar la sincronización, se requiere configurar la Google Calendar API con credenciales OAuth 2.0, 
                                lo cual no es posible en este entorno limitado. En una implementación real, se necesitaría un backend con Node.js/Express.
                            </div>
                        </div>

                        <!-- Promotions Tab -->
                        <div class="tab-pane fade" id="promotions-admin">
                            <div class="d-flex justify-content-between mb-3">
                                <h5><i class="fas fa-tags me-2"></i>Gestión de Promociones</h5>
                                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addPromotionModal">
                                    <i class="fas fa-plus me-1"></i>Nueva Promoción
                                </button>
                            </div>
                            <div id="admin-promotions-list">
                                <!-- Promotions will be populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Gallery Tab -->
                        <div class="tab-pane fade" id="gallery-admin">
                            <h5><i class="fas fa-images me-2"></i>Gestión de Galería</h5>
                            <p class="text-muted">Suba nuevas imágenes para la galería del spa</p>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Subir Nueva Imagen</label>
                                        <input type="file" class="form-control" accept="image/*" id="gallery-image-input">
                                        <div class="form-text">Formatos soportados: JPG, PNG, GIF</div>
                                    </div>
                                    <div class="preview-container" id="image-preview">
                                        <i class="fas fa-cloud-upload-alt fa-3x text-muted"></i>
                                    </div>
                                    <button class="btn btn-primary" id="upload-gallery-image">Subir Imagen</button>
                                </div>
                                <div class="col-md-6">
                                    <div class="mt-4" id="admin-gallery-container">
                                        <!-- Admin gallery will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Modals -->
    <div class="modal fade" id="addAppointmentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Agregar Nuevo Turno</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="mb-3">
                            <label class="form-label">Nombre del Cliente</label>
                            <input type="text" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Teléfono</label>
                            <input type="tel" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Fecha y Hora</label>
                            <input type="datetime-local" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tipo de Masaje</label>
                            <select class="form-select">
                                <option>Masaje Relajante</option>
                                <option>Masaje Descontracturante</option>
                                <option>Masaje Deportivo</option>
                                <option>Pareja Romántica</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary">Guardar Turno</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addPromotionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nueva Promoción</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="promotion-form">
                        <div class="mb-3">
                            <label class="form-label">Título *</label>
                            <input type="text" class="form-control" id="promotion-title" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descripción *</label>
                            <textarea class="form-control" id="promotion-description" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descuento/Precio *</label>
                            <input type="text" class="form-control" id="promotion-price" placeholder="Ej: 20% OFF - $45.000" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="save-promotion">Crear Promoción</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editPromotionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Promoción</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-promotion-form">
                        <input type="hidden" id="edit-promotion-id">
                        <div class="mb-3">
                            <label class="form-label">Título *</label>
                            <input type="text" class="form-control" id="edit-promotion-title" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descripción *</label>
                            <textarea class="form-control" id="edit-promotion-description" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descuento/Precio *</label>
                            <input type="text" class="form-control" id="edit-promotion-price" placeholder="Ej: 20% OFF - $45.000" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning" id="update-promotion">Actualizar Promoción</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container text-center">
            <p>&copy; 2025 Spa Roxi - Todos los derechos reservados</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Data storage - Use try-catch to handle localStorage issues
        let appointments = [];
        let promotions = [];
        let galleryImages = [];
        
        try {
            appointments = JSON.parse(localStorage.getItem('spa_appointments') || '[]');
            promotions = JSON.parse(localStorage.getItem('spa_promotions') || JSON.stringify([
                { id: 1, title: 'Masaje Relajante', description: '60 minutos de puro relax con aceites esenciales', price: '20% OFF - $45.000' },
                { id: 2, title: 'Masaje Descontracturante', description: 'Ideal para aliviar tensiones musculares', price: '15% OFF - $55.000' },
                { id: 3, title: 'Pareja Romántica', description: 'Masajes simultáneos para dos personas', price: '10% OFF - $120.000' }
            ]));
            galleryImages = JSON.parse(localStorage.getItem('spa_gallery') || '[]');
        } catch (e) {
            console.warn('Error loading from localStorage, using defaults');
            appointments = [];
            promotions = [
                { id: 1, title: 'Masaje Relajante', description: '60 minutos de puro relax con aceites esenciales', price: '20% OFF - $45.000' },
                { id: 2, title: 'Masaje Descontracturante', description: 'Ideal para aliviar tensiones musculares', price: '15% OFF - $55.000' },
                { id: 3, title: 'Pareja Romántica', description: 'Masajes simultáneos para dos personas', price: '10% OFF - $120.000' }
            ];
            galleryImages = [];
        }
        
        // Masaje types with durations
        const masajeTypes = {
            relajante: { name: 'Masaje Relajante', duration: 60 },
            descontracturante: { name: 'Masaje Descontracturante', duration: 75 },
            deportivo: { name: 'Masaje Deportivo', duration: 90 },
            pareja: { name: 'Pareja Romántica', duration: 120 }
        };
        
        // Set minimum date to today
        const today = new Date();
        const dateString = today.toISOString().split('T')[0];
        document.getElementById('booking-date').min = dateString;
        document.getElementById('booking-date').value = dateString;
        
        // Event Listeners
        document.getElementById('booking-date').addEventListener('change', loadAvailableSlots);
        document.getElementById('booking-type').addEventListener('change', loadAvailableSlots);
        document.getElementById('confirm-booking').addEventListener('click', confirmBooking);
        document.getElementById('back-to-slots').addEventListener('click', () => {
            document.getElementById('booking-form').classList.add('hidden');
            document.getElementById('time-slots').classList.remove('hidden');
        });
        document.getElementById('save-promotion').addEventListener('click', saveNewPromotion);
        document.getElementById('update-promotion').addEventListener('click', updateExistingPromotion);
        document.getElementById('upload-gallery-image').addEventListener('click', addGalleryImage);
        
        // CORRECCIÓN CLAVE: Vincular correctamente el evento change al input de imagen
        const imageInput = document.getElementById('gallery-image-input');
        if (imageInput) {
            imageInput.addEventListener('change', function(e) {
                previewImage(e);
            });
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadPublicPromotions();
            loadPublicGallery();
            loadAvailableSlots();
            
            const hash = window.location.hash;
            if (hash === '#admin') {
                const adminSection = document.getElementById('admin');
                if (adminSection) {
                    adminSection.scrollIntoView({ behavior: 'smooth' });
                }
            }
        });
        
        // CORRECCIÓN DE LA FUNCIÓN DE VISTA PREVIA - AHORA FUNCIONA CORRECTAMENTE
        function previewImage(event) {
            const input = event.target;
            const previewContainer = document.getElementById('image-preview');
            
            if (!previewContainer) return;
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'preview-image';
                        img.alt = 'Vista previa de la imagen';
                        img.style.maxWidth = '100%';
                        img.style.maxHeight = '180px';
                        img.style.objectFit = 'contain';
                        
                        previewContainer.innerHTML = '';
                        previewContainer.appendChild(img);
                    } catch (error) {
                        console.error('Error creating preview image:', error);
                        previewContainer.innerHTML = '<i class="fas fa-exclamation-triangle fa-3x text-danger"></i>';
                    }
                };
                
                reader.onerror = function() {
                    previewContainer.innerHTML = '<i class="fas fa-exclamation-triangle fa-3x text-danger"></i>';
                };
                
                reader.readAsDataURL(input.files[0]);
            } else {
                previewContainer.innerHTML = '<i class="fas fa-cloud-upload-alt fa-3x text-muted"></i>';
            }
        }
        
        // Load available slots for selected date
        function loadAvailableSlots() {
            const selectedDate = document.getElementById('booking-date')?.value;
            const selectedType = document.getElementById('booking-type')?.value;
            const slotsContainer = document.getElementById('slots-container');
            
            if (!selectedDate || !selectedType || !slotsContainer) return;
            
            slotsContainer.innerHTML = '';
            
            // Get occupied slots for this date
            const occupiedSlots = appointments
                .filter(app => app.date === selectedDate)
                .map(app => app.time);
            
            // Generate available slots
            const startTime = 9; // 9 AM
            const endTime = 19; // 7 PM
            const duration = masajeTypes[selectedType]?.duration || 60;
            const slotInterval = Math.ceil(duration / 30) * 30;
            
            let currentTime = startTime;
            while (currentTime + (duration / 60) <= endTime) {
                const hour = String(currentTime).padStart(2, '0');
                const timeSlot = `${hour}:00`;
                
                const slotDiv = document.createElement('div');
                slotDiv.className = occupiedSlots.includes(timeSlot) ? 'booked-slot' : 'available-slot';
                slotDiv.innerHTML = `
                    <strong>${timeSlot}</strong> - ${masajeTypes[selectedType]?.name || 'Masaje'} (${duration} min)
                    ${occupiedSlots.includes(timeSlot) ? '<br><small class="text-danger">❌ No disponible</small>' : '<br><small class="text-success">✅ Disponible</small>'}
                `;
                
                if (!occupiedSlots.includes(timeSlot)) {
                    slotDiv.addEventListener('click', () => selectTimeSlot(timeSlot));
                }
                
                slotsContainer.appendChild(slotDiv);
                currentTime += slotInterval / 60;
            }
        }
        
        // Select time slot
        function selectTimeSlot(time) {
            window.selectedTimeSlot = time;
            const bookingForm = document.getElementById('booking-form');
            const timeSlots = document.getElementById('time-slots');
            
            if (bookingForm && timeSlots) {
                bookingForm.classList.remove('hidden');
                timeSlots.classList.add('hidden');
            }
        }
        
        // Confirm booking
        function confirmBooking() {
            const name = document.getElementById('client-name')?.value?.trim();
            const phone = document.getElementById('client-phone')?.value?.trim();
            const date = document.getElementById('booking-date')?.value;
            const type = document.getElementById('booking-type')?.value;
            
            if (!name || !phone || !date || !type) {
                alert('Por favor complete todos los campos obligatorios.');
                return;
            }
            
            if (!window.selectedTimeSlot) {
                alert('Por favor seleccione un horario disponible.');
                return;
            }
            
            // Add to appointments
            const newAppointment = {
                id: Date.now(),
                date: date,
                time: window.selectedTimeSlot,
                name: name,
                phone: phone,
                type: type
            };
            
            appointments.push(newAppointment);
            
            try {
                localStorage.setItem('spa_appointments', JSON.stringify(appointments));
            } catch (e) {
                console.warn('Could not save to localStorage');
            }
            
            // Show confirmation
            const masajeInfo = masajeTypes[type];
            const confirmationText = document.getElementById('booking-confirmation-text');
            
            if (confirmationText) {
                confirmationText.innerHTML = `
                    <strong>Reserva confirmada con éxito!</strong><br>
                    <strong>Nombre:</strong> ${name}<br>
                    <strong>Teléfono:</strong> ${phone}<br>
                    <strong>Fecha:</strong> ${formatDate(date)}<br>
                    <strong>Hora:</strong> ${window.selectedTimeSlot}<br>
                    <strong>Servicio:</strong> ${masajeInfo?.name || 'Masaje'} (${masajeInfo?.duration || 60} minutos)
                `;
            }
            
            const bookingForm = document.getElementById('booking-form');
            const bookingSuccess = document.getElementById('booking-success');
            
            if (bookingForm && bookingSuccess) {
                bookingForm.classList.add('hidden');
                bookingSuccess.classList.remove('hidden');
            }
            
            // Reset form
            if (document.getElementById('client-name')) {
                document.getElementById('client-name').value = '';
            }
            if (document.getElementById('client-phone')) {
                document.getElementById('client-phone').value = '';
            }
        }
        
        // Reset booking form
        function resetBookingForm() {
            const bookingSuccess = document.getElementById('booking-success');
            const timeSlots = document.getElementById('time-slots');
            
            if (bookingSuccess && timeSlots) {
                bookingSuccess.classList.add('hidden');
                timeSlots.classList.remove('hidden');
            }
            
            loadAvailableSlots();
        }
        
        // Format date for display
        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('es-ES', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            } catch (e) {
                return dateString;
            }
        }
        
        // Load public promotions
        function loadPublicPromotions() {
            const container = document.getElementById('public-promotions-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            promotions.forEach(promo => {
                const promoDiv = document.createElement('div');
                promoDiv.className = 'col-md-4 mb-4';
                promoDiv.innerHTML = `
                    <div class="card promotion-item">
                        <div class="card-body">
                            <h5 class="card-title">${promo.title}</h5>
                            <p class="card-text">${promo.description}</p>
                            <p class="fw-bold text-success">${promo.price}</p>
                        </div>
                    </div>
                `;
                container.appendChild(promoDiv);
            });
        }
        
        // Load public gallery
        function loadPublicGallery() {
            const container = document.getElementById('gallery-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (galleryImages.length === 0) {
                // Add placeholder images
                for (let i = 0; i < 4; i++) {
                    const col = document.createElement('div');
                    col.className = 'col-md-3 mb-3';
                    col.innerHTML = `
                        <div class="image-placeholder">
                            <i class="fas fa-image fa-3x"></i>
                        </div>
                    `;
                    container.appendChild(col);
                }
            } else {
                galleryImages.forEach(img => {
                    const col = document.createElement('div');
                    col.className = 'col-md-3 mb-3';
                    col.innerHTML = `
                        <img src="${img}" class="img-fluid rounded" style="height: 200px; object-fit: cover;">
                    `;
                    container.appendChild(col);
                });
            }
        }
        
        // Admin authentication
        document.getElementById('login-form')?.addEventListener('submit', function(e) {
            e.preventDefault();
            const passwordInput = document.getElementById('password');
            if (!passwordInput) return;
            
            const password = passwordInput.value;
            if (password === 'roxi123') {
                const loginSection = document.getElementById('login-section');
                const adminDashboard = document.getElementById('admin-dashboard');
                
                if (loginSection && adminDashboard) {
                    loginSection.classList.add('hidden');
                    adminDashboard.classList.remove('hidden');
                    updateAdminViews();
                }
            } else {
                alert('Contraseña incorrecta. Intente nuevamente.');
            }
        });
        
        // Update all admin views
        function updateAdminViews() {
            updateAdminAppointmentsList();
            updateAdminPromotionsList();
            updateAdminGallery();
        }
        
        // Update admin appointments list
        function updateAdminAppointmentsList() {
            const container = document.getElementById('admin-appointments-list');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (appointments.length === 0) {
                container.innerHTML = '<p class="text-muted">No hay turnos programados.</p>';
                return;
            }
            
            appointments.forEach(app => {
                const appDiv = document.createElement('div');
                appDiv.className = 'appointment-card';
                appDiv.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>${app.name}</strong><br>
                            <small>${app.date} - ${app.time}</small><br>
                            <small>${masajeTypes[app.type]?.name || app.type}</small><br>
                            <small class="text-muted">Tel: ${app.phone}</small>
                        </div>
                        <button class="btn btn-sm btn-danger" onclick="deleteAppointment(${app.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                container.appendChild(appDiv);
            });
        }
        
        // Update admin promotions list
        function updateAdminPromotionsList() {
            const container = document.getElementById('admin-promotions-list');
            if (!container) return;
            
            container.innerHTML = '';
            
            promotions.forEach(promo => {
                const promoDiv = document.createElement('div');
                promoDiv.className = 'card mb-3';
                promoDiv.innerHTML = `
                    <div class="card-body">
                        <h6 class="card-title">${promo.title}</h6>
                        <p class="card-text">${promo.description}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="badge bg-success">${promo.price}</span>
                            <div>
                                <button class="btn btn-sm btn-warning me-2" onclick="editPromotion(${promo.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deletePromotion(${promo.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(promoDiv);
            });
        }
        
        // Update admin gallery
        function updateAdminGallery() {
            const container = document.getElementById('admin-gallery-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (galleryImages.length === 0) {
                container.innerHTML = '<p class="text-muted">No hay imágenes en la galería.</p>';
                return;
            }
            
            galleryImages.forEach((img, index) => {
                const imgDiv = document.createElement('div');
                imgDiv.className = 'col-md-3 mb-3';
                imgDiv.innerHTML = `
                    <div class="position-relative">
                        <img src="${img}" class="img-fluid rounded" style="height: 150px; object-fit: cover;">
                        <button class="btn btn-danger btn-sm position-absolute top-0 end-0 m-2" onclick="deleteGalleryImage(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                container.appendChild(imgDiv);
            });
        }
        
        // Save new promotion
        function saveNewPromotion() {
            const title = document.getElementById('promotion-title')?.value?.trim();
            const description = document.getElementById('promotion-description')?.value?.trim();
            const price = document.getElementById('promotion-price')?.value?.trim();
            
            if (!title || !description || !price) {
                alert('Todos los campos son obligatorios.');
                return;
            }
            
            const newPromotion = {
                id: Date.now(),
                title: title,
                description: description,
                price: price
            };
            
            promotions.push(newPromotion);
            
            try {
                localStorage.setItem('spa_promotions', JSON.stringify(promotions));
            } catch (e) {
                console.warn('Could not save promotions to localStorage');
            }
            
            // Close modal and update views
            const modalElement = document.getElementById('addPromotionModal');
            if (modalElement) {
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) modal.hide();
            }
            
            updateAdminPromotionsList();
            loadPublicPromotions();
            
            // Reset form
            const form = document.getElementById('promotion-form');
            if (form) form.reset();
        }
        
        // Edit promotion
        function editPromotion(id) {
            const promo = promotions.find(p => p.id === id);
            if (!promo) return;
            
            const idInput = document.getElementById('edit-promotion-id');
            const titleInput = document.getElementById('edit-promotion-title');
            const descriptionInput = document.getElementById('edit-promotion-description');
            const priceInput = document.getElementById('edit-promotion-price');
            
            if (idInput && titleInput && descriptionInput && priceInput) {
                idInput.value = promo.id;
                titleInput.value = promo.title;
                descriptionInput.value = promo.description;
                priceInput.value = promo.price;
                
                const modalElement = document.getElementById('editPromotionModal');
                if (modalElement) {
                    const modal = new bootstrap.Modal(modalElement);
                    modal.show();
                }
            }
        }
        
        // Update existing promotion
        function updateExistingPromotion() {
            const idInput = document.getElementById('edit-promotion-id');
            const titleInput = document.getElementById('edit-promotion-title');
            const descriptionInput = document.getElementById('edit-promotion-description');
            const priceInput = document.getElementById('edit-promotion-price');
            
            if (!idInput || !titleInput || !descriptionInput || !priceInput) return;
            
            const id = parseInt(idInput.value);
            const title = titleInput.value.trim();
            const description = descriptionInput.value.trim();
            const price = priceInput.value.trim();
            
            if (!title || !description || !price) {
                alert('Todos los campos son obligatorios.');
                return;
            }
            
            const promoIndex = promotions.findIndex(p => p.id === id);
            if (promoIndex !== -1) {
                promotions[promoIndex] = {
                    id: id,
                    title: title,
                    description: description,
                    price: price
                };
                
                try {
                    localStorage.setItem('spa_promotions', JSON.stringify(promotions));
                } catch (e) {
                    console.warn('Could not update promotions in localStorage');
                }
                
                updateAdminPromotionsList();
                loadPublicPromotions();
                
                // Close modal
                const modalElement = document.getElementById('editPromotionModal');
                if (modalElement) {
                    const modal = bootstrap.Modal.getInstance(modalElement);
                    if (modal) modal.hide();
                }
            }
        }
        
        // Delete promotion
        function deletePromotion(id) {
            if (confirm('¿Está seguro de eliminar esta promoción?')) {
                promotions = promotions.filter(p => p.id !== id);
                
                try {
                    localStorage.setItem('spa_promotions', JSON.stringify(promotions));
                } catch (e) {
                    console.warn('Could not delete promotion from localStorage');
                }
                
                updateAdminPromotionsList();
                loadPublicPromotions();
            }
        }
        
        // Delete appointment
        function deleteAppointment(id) {
            if (confirm('¿Está seguro de eliminar este turno?')) {
                appointments = appointments.filter(a => a.id !== id);
                
                try {
                    localStorage.setItem('spa_appointments', JSON.stringify(appointments));
                } catch (e) {
                    console.warn('Could not delete appointment from localStorage');
                }
                
                updateAdminAppointmentsList();
                loadAvailableSlots(); // Refresh available slots
            }
        }
        
        // Add gallery image
        function addGalleryImage() {
            const input = document.getElementById('gallery-image-input');
            const previewContainer = document.getElementById('image-preview');
            
            if (!input || !previewContainer) return;
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        galleryImages.push(e.target.result);
                        
                        try {
                            localStorage.setItem('spa_gallery', JSON.stringify(galleryImages));
                        } catch (e) {
                            console.warn('Could not save gallery to localStorage');
                        }
                        
                        updateAdminGallery();
                        loadPublicGallery();
                        
                        // Clear the input after upload to allow re-selection of same file
                        input.value = '';
                        // Keep the preview visible
                    } catch (error) {
                        console.error('Error adding gallery image:', error);
                        alert('Error al procesar la imagen. Intente con otro archivo.');
                    }
                };
                
                reader.onerror = function() {
                    alert('Error al leer el archivo de imagen.');
                };
                
                reader.readAsDataURL(file);
            } else {
                alert('Por favor seleccione una imagen para subir.');
            }
        }
        
        // Delete gallery image
        function deleteGalleryImage(index) {
            if (confirm('¿Está seguro de eliminar esta imagen?')) {
                galleryImages.splice(index, 1);
                
                try {
                    localStorage.setItem('spa_gallery', JSON.stringify(galleryImages));
                } catch (e) {
                    console.warn('Could not delete gallery image from localStorage');
                }
                
                updateAdminGallery();
                loadPublicGallery();
                // Clear preview when deleting
                const previewContainer = document.getElementById('image-preview');
                if (previewContainer) {
                    previewContainer.innerHTML = '<i class="fas fa-cloud-upload-alt fa-3x text-muted"></i>';
                }
            }
        }
        
        // Global error handling for delete functions
        window.deleteAppointment = deleteAppointment;
        window.deletePromotion = deletePromotion;
        window.editPromotion = editPromotion;
        window.deleteGalleryImage = deleteGalleryImage;
    </script>
</body>
</html>


